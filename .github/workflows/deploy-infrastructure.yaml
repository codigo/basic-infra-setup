name: Deploy Infrastructure

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".claude/**"

env:
  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  HETZNER_CLOUD_KEY: ${{ secrets.HETZNER_CLOUD_KEY }}
  PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
  CLOUDFLARE_TUNNEL_SECRET: ${{ secrets.CLOUDFLARE_TUNNEL_SECRET }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm ci

      - name: Process configuration files
        env:
          DOZZLE_PASSWORD: ${{ secrets.DOZZLE_PASSWORD }}
          CONTAINER_REGISTRY_URL: ${{ vars.CONTAINER_REGISTRY_URL }}
          CONTAINER_REGISTRY_USERNAME: ${{ secrets.CONTAINER_REGISTRY_USERNAME }}
          CONTAINER_REGISTRY_PASSWORD: ${{ secrets.CONTAINER_REGISTRY_PASSWORD }}
          INFISICAL_ENCRYPTION_KEY: ${{ secrets.INFISICAL_ENCRYPTION_KEY }}
          INFISICAL_AUTH_SECRET: ${{ secrets.INFISICAL_AUTH_SECRET }}
          INFISICAL_DB_PASSWORD: ${{ secrets.INFISICAL_DB_PASSWORD }}
          INFISICAL_SMTP_PASSWORD: ${{ secrets.INFISICAL_SMTP_PASSWORD }}
        run: |
          files=(
            "./tooling/data/dozzle/users.yaml"
            "./docker-compose.tooling.yaml"
          )

          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "Processing $file"

              # Use sed to replace variables
              sed -i.bak -e '
                s|{{ DOZZLE_PASSWORD }}|'"$DOZZLE_PASSWORD"'|g
                s|{{ CONTAINER_REGISTRY_URL }}|'"$CONTAINER_REGISTRY_URL"'|g
                s|{{ CONTAINER_REGISTRY_USERNAME }}|'"$CONTAINER_REGISTRY_USERNAME"'|g
                s|{{ CONTAINER_REGISTRY_PASSWORD }}|'"$CONTAINER_REGISTRY_PASSWORD"'|g
                s|{{ INFISICAL_ENCRYPTION_KEY }}|'"$INFISICAL_ENCRYPTION_KEY"'|g
                s|{{ INFISICAL_AUTH_SECRET }}|'"$INFISICAL_AUTH_SECRET"'|g
                s|{{ INFISICAL_DB_PASSWORD }}|'"$INFISICAL_DB_PASSWORD"'|g
                s|{{ INFISICAL_SMTP_PASSWORD }}|'"$INFISICAL_SMTP_PASSWORD"'|g
              ' "$file"

              echo "Processed $file"
            else
              echo "File not found: $file"
            fi
          done

      - name: Setup SSH keys
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_rsa.pub
          chmod 600 ~/.ssh/id_rsa
          chmod 644 ~/.ssh/id_rsa.pub

          # Verify SSH key files
          ls -l ~/.ssh
          wc -l ~/.ssh/id_rsa ~/.ssh/id_rsa.pub

      - name: Setup Pulumi
        uses: pulumi/actions@v5

      - name: Configure Pulumi
        run: |
          pulumi stack select codigo/mau-app/codigo-services
          pulumi config set aws:region ${{ vars.AWS_REGION }}
          pulumi config set --secret hcloud:token ${{ secrets.HETZNER_CLOUD_KEY }}
          pulumi config set appName mau-app

          # Set configs from secrets and vars
          pulumi config set --secret awsAccessKeyId "${{ secrets.AWS_ACCESS_KEY_ID }}"
          pulumi config set --secret awsSecretAccessKey "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          pulumi config set --secret dockerUsername "${{ secrets.CONTAINER_REGISTRY_USERNAME }}"
          pulumi config set --secret dockerPassword "${{ secrets.CONTAINER_REGISTRY_PASSWORD }}"
          pulumi config set dockerRegistry "${{ vars.CONTAINER_REGISTRY_URL }}"

          # Set SSH keys
          cat ~/.ssh/id_rsa.pub | openssl base64 | tr -d '\n' | pulumi config set sshPublicKey --secret
          cat ~/.ssh/id_rsa | openssl base64 | tr -d '\n' | pulumi config set sshPrivateKey --secret

          # Set configs from files
          for file in ./tooling/data/dozzle/users.yaml ./tooling/data/caddy/Caddyfile; do
            pulumi config set --secret $(basename $file .yaml | tr '.-' '_') "$(cat $file)"
          done

          pulumi config set docker_compose_tooling "$(cat ./docker-compose.tooling.yaml)"

          # Set configs from bin scripts
          for script in backupData uploadToS3 restoreAndCopyBackup; do
            pulumi config set --secret ${script}Script "$(cat ./bin/${script}.js)"
          done

          # Set backup directory
          pulumi config set backupDir ${{ vars.BACKUP_DIR }}

          # Set Cloudflare tunnel configurations
          pulumi config set --secret cloudflareAccountId "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          pulumi config set --secret cloudflareCodigoZoneId "${{ secrets.CLOUDFLARE_CODIGO_ZONE_ID }}"
          pulumi config set --secret cloudflareMaumercadoZoneId "${{ secrets.CLOUDFLARE_MAUMERCADO_ZONE_ID }}"
          pulumi config set --secret cloudflare:apiToken "${{ secrets.CLOUDFLARE_API_TOKEN }}"

          # Debug: Check Pulumi config (be careful not to expose secrets)
          pulumi config get appName
          pulumi config get aws:region

        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}

      - name: Deploy infrastructure
        uses: pulumi/actions@v5
        with:
          command: up
          stack-name: codigo/mau-app/codigo-services
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
